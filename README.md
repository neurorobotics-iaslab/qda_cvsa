## qda_cvsa

This directory contains the QDA (Quadratic Discriminant Analysis) classifier node. This node is responsible for the real-time classification of EEG (power-band) features, specifically to detect the **IC (Impaired Consciousness)** state using a pre-trained QDA model.

---

### 1. Input

* **Topic:** `/cvsa/eeg_power`
* **Data:** The node subscribes to this topic. The message structure is defined by the `cvsa_processing` package. The node expects the `msg.data` field to contain a flattened matrix of EEG signal power, structured as `[channels x bands]`.

---

### 2. Configuration

This node **requires a YAML configuration file** that defines the QDA model and all necessary processing parameters. The model's YAML file is saved in the `cfg` repository (e.g., `cfg/qda_model.yaml`).

The YAML file must contain the following fields:

* `indices`: A list of integers. These are the specific indices from the `[channels x bands]` input matrix that will be used to construct the feature vector.
* `bands`: A list of strings specifying the frequency bands used (e.g., `['delta', 'theta']`).
* `channels`: A list of strings specifying the channels used (e.g., `['F3', 'F4']`).
* `files_used`: A list of strings specifying the original data files used for training.
* `kmeans_model`: The name (or path) of the K-Means YAML model used to generate the labels for this QDA model.
* `n_features`: The total number of features (must match the length of `indices`).
* `n_classes`: The number of classes (e.g., 2).
* `priors`: A list of floats `[n_classes]` representing the prior probabilities for each class.
* `means`: A nested list `[n_classes x n_features]` containing the mean vector for each class.
* `covariance`: A nested list `[n_classes x n_features x n_features]` containing the covariance matrix (or equivalent parameters like scaling/rotation) for each class.

---

### 3. Model Generation

The QDA model (the `.yaml` file) is generated using a **Python script** located in the `/create_qda` directory.

This script is responsible for:
1.  Loading the training dataset. This dataset is located in the `/create_qda/datasets` directory. **This directory is populated by the K-Means node** (see `kmeans_cvsa`), which extracts and saves the EEG data (already filtered for the IC state) and its corresponding class labels into a `.mat` file.
2.  Training the QDA model (using `sklearn` or a similar library) on this data.
3.  Exporting all required QDA parameters (`priors`, `means`, `covariance`, `indices`, etc.) and metadata (`files_used`, `kmeans_model`, `bands`, `channels`) into the YAML format required by this node.

---

### 4. Workflow

1.  **Load Model:** The node loads the QDA parameters (priors, means, covariances, indices) from the specified YAML file.
2.  **Receive Data:** It listens for incoming messages on `/cvsa/eeg_power`.
3.  **Extract Features:** Using the `indices` from the YAML file, the node builds the feature vector from the incoming `msg.data` array.
4.  **Classify:** The node calculates the posterior probability for each class using the loaded QDA parameters and assigns the data to the class with the highest probability (Bayesian decision).
5.  **Publish:** The node publishes the resulting classification probability (e.g., the probability of being in the IC state) to the output topic.

---

### 5. Output

* **Topic:** `/cvsa/neuroprediction/qda`
* **Data:** Publishes the classification probability. It is a `NeuroOutput` message, defined by the `rosneuro` package.

---

### 6. Testing

The validation tests for this node are located in the `test` directory.

The testing process validates the node's functionality by comparing the ROS node's output against a MATLAB simulation using the same model and data:

1.  **ROS Execution:** A launch file initiates the test. An auxiliary node publishes pre-defined data (e.g., from a CSV file) to the `/cvsa/eeg_power` topic. A second helper node subscribes to `/cvsa/neuroprediction/qda` and saves the resulting probabilities to a CSV file (e.g., `ros_output.csv`).
2.  **MATLAB Verification:** The output CSV file (`ros_output.csv`) is loaded into MATLAB.
3.  **Comparison:** The probabilities from the ROS node are compared against the results from an equivalent MATLAB implementation. This MATLAB script uses helper functions (also present in the `test` directory) that allow it to load and execute the QDA model from the YAML format generated by `sklearn` (Python). Both scripts process the *same* input data.

The test passes if the output probabilities from ROS and MATLAB are (almost) identical. **Currently, the accepted error between the two implementations is on the order of $10^{-7}$.**